# Изменения в логике расчета P&L для Grid Trading

## Проблема
Предыдущая логика расчета прибыли/убытков была неправильной для grid trading:
- Считала накопление (покупки) как убыток
- Не учитывала реальные сделки (открытие и закрытие позиций)
- Показывала отрицательную прибыль в дни накопления

## Решение

### 1. Отслеживание позиций
- Добавлено отслеживание позиций для каждой торговой пары
- Позиции отслеживаются глобально (между днями) и локально (внутри дня)
- Для каждой позиции хранится:
  - `totalAmount` - общее количество
  - `totalCost` - общая стоимость покупки
  - `averagePrice` - средняя цена покупки

### 2. Правильный расчет P&L
- **Реализованная прибыль** = Продажа - Стоимость покупки - Комиссии
- Накопление (покупки) больше не считается как убыток
- Показывается только чистая прибыль от закрытых позиций

### 3. Логика расчета
```javascript
// При покупке - обновляем позицию
positions[pair].totalAmount += amount;
positions[pair].totalCost += total;
positions[pair].averagePrice = totalCost / totalAmount;

// При продаже - рассчитываем прибыль
const sellValue = total;
const sellAmount = amount;
const avgBuyPrice = positions[pair].averagePrice;
const buyValue = sellAmount * avgBuyPrice;
const realizedPnL = sellValue - buyValue - fee;
```

### 4. Отображение информации
- Добавлено отображение количества открытых позиций в карточках дней
- Добавлена сводка по открытым позициям в боковой панели
- Показывается общая стоимость открытых позиций

### 5. Win Rate
- Win Rate теперь рассчитывается на основе прибыльных продаж
- Учитываются только сделки с положительной реализованной прибылью

## Результат
- Теперь показывается только **чистая реализованная прибыль**
- Накопление не считается как убыток
- Правильное отображение эффективности grid trading стратегии
- Информация об открытых позициях для лучшего понимания рисков