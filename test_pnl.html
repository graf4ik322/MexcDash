<!DOCTYPE html>
<html>
<head>
    <title>P&L Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/data-parser.js"></script>
</head>
<body>
    <h1>P&L Calculation Test</h1>
    <input type="file" id="fileInput" accept=".xlsx,.xls">
    <div id="output"></div>

    <script>
        const dataParser = new DataParser();
        
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    const output = document.getElementById('output');
                    output.innerHTML = '<p>Обработка файла...</p>';
                    
                    const result = await dataParser.parseFile(file);
                    
                    // Test P&L calculation
                    const dailyStats = Utils.calculateDailyStats(result.processed);
                    
                    output.innerHTML = `
                        <h2>Результат обработки</h2>
                        <p><strong>Всего строк:</strong> ${result.processed.length}</p>
                        <p><strong>Дней торговли:</strong> ${Object.keys(dailyStats).length}</p>
                        
                        <h3>Примеры обработанных данных:</h3>
                        <pre>${JSON.stringify(result.processed.slice(0, 3), null, 2)}</pre>
                        
                        <h3>Статистика по дням (первые 5):</h3>
                        <pre>${JSON.stringify(Object.entries(dailyStats).slice(0, 5), null, 2)}</pre>
                        
                        <h3>Общая статистика:</h3>
                        <p>Общая прибыль: ${Object.values(dailyStats).reduce((sum, day) => sum + day.profit, 0).toFixed(2)}</p>
                        <p>Дней с прибылью: ${Object.values(dailyStats).filter(day => day.profit > 0).length}</p>
                        <p>Дней с убытком: ${Object.values(dailyStats).filter(day => day.profit < 0).length}</p>
                        <p>Дней без операций: ${Object.values(dailyStats).filter(day => day.profit === 0).length}</p>
                    `;
                } catch (error) {
                    document.getElementById('output').innerHTML = `<p style="color: red;">Ошибка: ${error.message}</p>`;
                    console.error('Error:', error);
                }
            }
        });
    </script>
</body>
</html>