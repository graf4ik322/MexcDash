<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug HBAR_USDT</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ru.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f5f5f5; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .result { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .profit { color: green; font-weight: bold; }
        .loss { color: red; font-weight: bold; }
        .trade { margin: 5px 0; padding: 5px; background: #fff; border-left: 3px solid #007bff; }
        .buy { border-left-color: #28a745; }
        .sell { border-left-color: #dc3545; }
        .loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <h1>Debug HBAR_USDT Profit Calculation</h1>
    
    <input type="file" id="fileInput" accept=".xlsx,.xls">
    <button onclick="debugHBAR()">Debug HBAR_USDT</button>
    
    <div id="results"></div>
    
    <script>
        // Simple utility functions
        function formatCurrency(value) {
            const absValue = Math.abs(value);
            let formatted;
            
            if (absValue >= 1000000) {
                formatted = (absValue / 1000000).toFixed(2) + 'M';
            } else if (absValue >= 1000) {
                formatted = (absValue / 1000).toFixed(2) + 'K';
            } else {
                formatted = absValue.toFixed(2);
            }
            
            const sign = value >= 0 ? '+' : '-';
            return `${sign}${formatted} USDT`;
        }

        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            defval: '',
                            raw: false
                        });
                        
                        if (jsonData.length < 2) {
                            throw new Error('Excel файл должен содержать данные');
                        }
                        
                        console.log('Raw Excel data structure:', jsonData.slice(0, 3));
                        
                        // Use known headers from the file structure
                        const headers = ['Pairs', 'Time', 'Side', 'Filled Price', 'Executed Amount', 'Total', 'Fee', 'Role'];
                        const dataRows = jsonData.slice(1); // Start from second row
                        
                        console.log('Using headers:', headers);
                        
                        const processedData = dataRows.map((row, index) => {
                            const obj = {};
                            headers.forEach((header, colIndex) => {
                                if (row[colIndex] !== undefined && row[colIndex] !== null && row[colIndex] !== '') {
                                    obj[header] = row[colIndex];
                                } else {
                                    obj[header] = '';
                                }
                            });
                            return obj;
                        }).filter(row => {
                            return Object.values(row).some(value => value !== '' && value !== null && value !== undefined);
                        });
                        
                        console.log('Processed data sample:', processedData.slice(0, 3));
                        resolve(processedData);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function calculatePairProfit(trades) {
            console.log('Calculating pair profit for', trades.length, 'trades');
            
            // Group trades by pair
            const pairData = {};
            
            trades.forEach(trade => {
                const pair = trade.Pairs || 'UNKNOWN';
                const total = parseFloat(trade.Total) || 0;
                const fee = parseFloat(trade.Fee) || 0;
                const amount = parseFloat(trade['Executed Amount']) || 0;
                const price = parseFloat(trade['Filled Price']) || 0;
                const side = trade.Side;
                const time = trade.Time;
                
                if (!pairData[pair]) {
                    pairData[pair] = {
                        pair: pair,
                        trades: [],
                        totalBuyAmount: 0,
                        totalBuyValue: 0,
                        totalSellAmount: 0,
                        totalSellValue: 0,
                        totalFees: 0,
                        currentPosition: {
                            amount: 0,
                            cost: 0,
                            avgPrice: 0
                        },
                        realizedProfit: 0,
                        unrealizedProfit: 0
                    };
                }
                
                // Add trade to history
                pairData[pair].trades.push({
                    time: time,
                    side: side,
                    amount: amount,
                    price: price,
                    total: total,
                    fee: fee
                });
                
                // Update totals
                pairData[pair].totalFees += fee;
                
                if (side === 'Buy') {
                    pairData[pair].totalBuyAmount += amount;
                    pairData[pair].totalBuyValue += total;
                    
                    // Update current position
                    const current = pairData[pair].currentPosition;
                    const newAmount = current.amount + amount;
                    const newCost = current.cost + total;
                    
                    current.amount = newAmount;
                    current.cost = newCost;
                    current.avgPrice = newCost / newAmount;
                    
                    console.log(`${pair} BUY: ${amount} @ ${price} = ${total}`);
                    console.log(`  Position: ${current.amount} @ ${current.avgPrice.toFixed(6)} = ${current.cost.toFixed(2)}`);
                    
                } else if (side === 'Sell') {
                    pairData[pair].totalSellAmount += amount;
                    pairData[pair].totalSellValue += total;
                    
                    // Calculate realized profit from this sell
                    const current = pairData[pair].currentPosition;
                    if (current.amount > 0) {
                        const buyValue = amount * current.avgPrice;
                        const realizedProfit = total - buyValue - fee;
                        pairData[pair].realizedProfit += realizedProfit;
                        
                        console.log(`${pair} SELL: ${amount} @ ${price} = ${total}`);
                        console.log(`  Buy value: ${amount} * ${current.avgPrice.toFixed(6)} = ${buyValue.toFixed(2)}`);
                        console.log(`  Profit: ${total} - ${buyValue.toFixed(2)} - ${fee} = ${realizedProfit.toFixed(2)}`);
                        
                        // Update position
                        current.amount -= amount;
                        if (current.amount <= 0) {
                            current.amount = 0;
                            current.cost = 0;
                            current.avgPrice = 0;
                            console.log(`  Position fully closed`);
                        } else {
                            current.cost = current.amount * current.avgPrice;
                            console.log(`  New position: ${current.amount} @ ${current.avgPrice.toFixed(6)} = ${current.cost.toFixed(2)}`);
                        }
                    } else {
                        console.log(`${pair} SELL: ${amount} @ ${price} = ${total} (no position to close)`);
                    }
                }
            });
            
            // Calculate final statistics
            Object.keys(pairData).forEach(pairKey => {
                const pair = pairData[pairKey];
                
                // Calculate net profit (only realized profit)
                pair.netProfit = pair.realizedProfit;
                
                // Calculate profit percentage based on total buy value
                if (pair.totalBuyValue > 0) {
                    pair.profitPercentage = (pair.netProfit / pair.totalBuyValue) * 100;
                } else {
                    pair.profitPercentage = 0;
                }
                
                // Calculate trade count
                pair.tradeCount = pair.trades.length;
                pair.buyCount = pair.trades.filter(t => t.side === 'Buy').length;
                pair.sellCount = pair.trades.filter(t => t.side === 'Sell').length;
                
                console.log(`${pair.pair} FINAL:`, {
                    buyValue: pair.totalBuyValue.toFixed(2),
                    sellValue: pair.totalSellValue.toFixed(2),
                    realizedProfit: pair.realizedProfit.toFixed(2),
                    fees: pair.totalFees.toFixed(2),
                    currentPosition: pair.currentPosition.amount.toFixed(6),
                    profitPercentage: pair.profitPercentage.toFixed(2) + '%'
                });
            });
            
            return pairData;
        }

        async function debugHBAR() {
            const fileInput = document.getElementById('fileInput');
            const resultsDiv = document.getElementById('results');
            
            if (!fileInput.files[0]) {
                alert('Выберите файл');
                return;
            }
            
            const file = fileInput.files[0];
            resultsDiv.innerHTML = '<div class="loading">Обработка файла...</div>';
            
            try {
                const processedData = await parseExcelFile(file);
                const pairData = calculatePairProfit(processedData);
                
                console.log('Full result:', { processed: processedData, pairs: pairData });
                
                // Filter HBAR_USDT trades
                const hbarTrades = processedData.filter(trade => trade.Pairs === 'HBAR_USDT');
                
                console.log('HBAR_USDT trades:', hbarTrades);
                
                let html = '<h2>HBAR_USDT Analysis</h2>';
                
                // Show all HBAR trades
                html += '<h3>All HBAR_USDT Trades:</h3>';
                hbarTrades.forEach((trade, index) => {
                    const tradeClass = trade.Side === 'Buy' ? 'buy' : 'sell';
                    html += `
                        <div class="trade ${tradeClass}">
                            <strong>${index + 1}. ${trade.Side}</strong><br>
                            Amount: ${trade['Executed Amount']}<br>
                            Price: ${trade['Filled Price']}<br>
                            Total: ${trade.Total}<br>
                            Fee: ${trade.Fee}<br>
                            Time: ${trade.Time}
                        </div>
                    `;
                });
                
                // Show pair data
                if (pairData && pairData.HBAR_USDT) {
                    const hbarData = pairData.HBAR_USDT;
                    html += `
                        <h3>HBAR_USDT Summary:</h3>
                        <div class="result">
                            <p><strong>Total Buy Value:</strong> ${hbarData.totalBuyValue.toFixed(2)} USDT</p>
                            <p><strong>Total Sell Value:</strong> ${hbarData.totalSellValue.toFixed(2)} USDT</p>
                            <p><strong>Total Fees:</strong> ${hbarData.totalFees.toFixed(2)} USDT</p>
                            <p><strong>Realized Profit:</strong> <span class="${hbarData.realizedProfit >= 0 ? 'profit' : 'loss'}">${hbarData.realizedProfit.toFixed(2)} USDT</span></p>
                            <p><strong>Net Profit:</strong> <span class="${hbarData.netProfit >= 0 ? 'profit' : 'loss'}">${hbarData.netProfit.toFixed(2)} USDT</span></p>
                            <p><strong>Profit Percentage:</strong> ${hbarData.profitPercentage.toFixed(2)}%</p>
                            <p><strong>Trade Count:</strong> ${hbarData.tradeCount}</p>
                            <p><strong>Buy Count:</strong> ${hbarData.buyCount}</p>
                            <p><strong>Sell Count:</strong> ${hbarData.sellCount}</p>
                            <p><strong>Current Position:</strong> ${hbarData.currentPosition.amount.toFixed(6)}</p>
                        </div>
                    `;
                }
                
                // Manual calculation
                html += '<h3>Manual Calculation:</h3>';
                let totalBuyValue = 0;
                let totalSellValue = 0;
                let totalFees = 0;
                let position = { amount: 0, cost: 0, avgPrice: 0 };
                let realizedProfit = 0;
                
                hbarTrades.forEach((trade, index) => {
                    const total = parseFloat(trade.Total) || 0;
                    const fee = parseFloat(trade.Fee) || 0;
                    const amount = parseFloat(trade['Executed Amount']) || 0;
                    const price = parseFloat(trade['Filled Price']) || 0;
                    
                    totalFees += fee;
                    
                    if (trade.Side === 'Buy') {
                        totalBuyValue += total;
                        
                        // Update position
                        const newAmount = position.amount + amount;
                        const newCost = position.cost + total;
                        position.amount = newAmount;
                        position.cost = newCost;
                        position.avgPrice = newCost / newAmount;
                        
                        html += `<div class="debug">BUY ${index + 1}: ${amount} @ ${price} = ${total} | Position: ${position.amount.toFixed(6)} @ ${position.avgPrice.toFixed(6)} = ${position.cost.toFixed(2)}</div>`;
                        
                    } else if (trade.Side === 'Sell') {
                        totalSellValue += total;
                        
                        if (position.amount > 0) {
                            const buyValue = amount * position.avgPrice;
                            const profit = total - buyValue - fee;
                            realizedProfit += profit;
                            
                            // Update position
                            position.amount -= amount;
                            if (position.amount <= 0) {
                                position.amount = 0;
                                position.cost = 0;
                                position.avgPrice = 0;
                            } else {
                                position.cost = position.amount * position.avgPrice;
                            }
                            
                            html += `<div class="debug">SELL ${index + 1}: ${amount} @ ${price} = ${total} | Buy Value: ${buyValue.toFixed(2)} | Profit: ${profit.toFixed(2)} | Position: ${position.amount.toFixed(6)}</div>`;
                        } else {
                            html += `<div class="debug">SELL ${index + 1}: ${amount} @ ${price} = ${total} | No position to close</div>`;
                        }
                    }
                });
                
                const netProfit = realizedProfit;
                const profitPercentage = totalBuyValue > 0 ? (netProfit / totalBuyValue) * 100 : 0;
                
                html += `
                    <h3>Manual Summary:</h3>
                    <div class="result">
                        <p><strong>Total Buy Value:</strong> ${totalBuyValue.toFixed(2)} USDT</p>
                        <p><strong>Total Sell Value:</strong> ${totalSellValue.toFixed(2)} USDT</p>
                        <p><strong>Total Fees:</strong> ${totalFees.toFixed(2)} USDT</p>
                        <p><strong>Realized Profit:</strong> <span class="${realizedProfit >= 0 ? 'profit' : 'loss'}">${realizedProfit.toFixed(2)} USDT</span></p>
                        <p><strong>Net Profit:</strong> <span class="${netProfit >= 0 ? 'profit' : 'loss'}">${netProfit.toFixed(2)} USDT</span></p>
                        <p><strong>Profit Percentage:</strong> ${profitPercentage.toFixed(2)}%</p>
                        <p><strong>Expected Profit:</strong> <span class="profit">73.81 USDT</span></p>
                        <p><strong>Difference:</strong> <span class="${Math.abs(netProfit - 73.81) < 1 ? 'profit' : 'loss'}">${(netProfit - 73.81).toFixed(2)} USDT</span></p>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<div class="debug">Ошибка: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>